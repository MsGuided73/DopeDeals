## VIP Smoke – Compliance Engine Build Guide
### Context
You are working in a monorepo (Replit) with:
* **Backend:** Node 18 (ESM), Express, Prisma ORM, Supabase PostgreSQL.
* **Frontend:** React 18 + TypeScript, Vite, Wouter, React Query, Tailwind + shadcn/ui.
* **Integrations:** Zoho Inventory (product import), ShipStation (fulfillment), Kajapay (payments).
* **Automation:** n8n (self‑hosted) for scheduled compliance audits.

Our goal is to enforce U.S. federal & state regulations for **THCA, Kratom, 7‑Hydroxy, Nicotine/Tobacco**, and any future high‑risk categories.

---

### Phase 1 – Database & Prisma

1. **Add / update models**  
   ```prisma
   model ComplianceRule {
     id                    String   @id @default(uuid())
     category              String                                   // "THCA", "Kratom", "Nicotine"
     substanceType         String?                                  // optional finer detail
     restrictedStates      String[]                                 // e.g. ["ID","IN","UT"]
     ageRequirement        Int      @default(21)                    // 18 or 21
     labTestingRequired    Boolean  @default(false)
     batchTrackingRequired Boolean  @default(false)
     warningLabels         String[]                                 // ["Not FDA approved"]
     shippingRestrictions  Json?                                    // catch‑all (weight limits, etc.)
     createdAt             DateTime @default(now())
     productLinks          ProductCompliance[]
   }

   model ProductCompliance {
     id             String          @id @default(uuid())
     productId      String
     complianceId   String
     product        Product         @relation(fields:[productId], references:[id])
     complianceRule ComplianceRule  @relation(fields:[complianceId], references:[id])

     @@unique([productId, complianceId])   // no duplicates
   }

   model Product {
     id                    String   @id @default(uuid())
     name                  String
     sku                   String
     description           String?
     price                 Float
     // --- Compliance flags ---
     nicotineProduct       Boolean  @default(false)
     visibleOnMainSite     Boolean  @default(true)   // must be FALSE if nicotineProduct = true
     visibleOnTobaccoSite  Boolean  @default(false)
     requiresLabTest       Boolean  @default(false)
     labTestUrl            String?
     batchNumber           String?
     expirationDate        DateTime?
     hiddenReason          String?
     overrideRestrictions  Json?
     // ---
     complianceLinks       ProductCompliance[]
     createdAt             DateTime @default(now())
     updatedAt             DateTime @updatedAt
   }

   model ComplianceAuditLog {
     id          String   @id @default(uuid())
     productId   String
     violation   String
     detectedAt  DateTime @default(now())
     resolvedBy  String?  // user id or "n8n"
   }
